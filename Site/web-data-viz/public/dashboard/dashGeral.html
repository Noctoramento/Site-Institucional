<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Noctoramento | Dashboard Geral</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/dashGeral.css" />
    <link rel="icon" href="../assets/Imagens/Logo Principal Verde água neon.png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <nav class="navbar">
        <img class="imgNavbar" src="../assets/icons_img/Logo Verde água escuro.png" alt="" />
        <ul class="iconsNavbar">
            <li>
                <svg width="24" height="24" viewBox="0 0 30 25" fill="#00ffff" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M3.4737 0.0560913C1.7378 0.0560913 0.330566 1.46993 0.330566 3.21399V20.8982C0.330566 22.6423 1.63302 24.0561 3.36893 24.0561H26.5233C28.2592 24.0561 29.6665 22.6423 29.6665 20.8982V3.21399C29.6665 1.46993 28.2592 0.0560913 26.5233 0.0560913H3.4737ZM3.26416 3.21399C3.26416 3.09772 3.35797 3.00346 3.4737 3.00346H9.13134V21.1087H3.4737C3.35797 21.1087 3.26416 21.0145 3.26416 20.8982V3.21399ZM12.0649 21.1087H17.9321V13.5298H12.0649V21.1087ZM12.0649 10.5824V3.00346H26.5233C26.6391 3.00346 26.7329 3.09772 26.7329 3.21399V10.5824L12.0649 10.5824ZM26.7329 13.5298H20.8657V21.1087H26.5233C26.6391 21.1087 26.7329 21.0145 26.7329 20.8982V13.5298Z" />
                </svg>
            </li>

            <li onclick="trocarTela('cadastroFuncionario')">
                <svg class="icons_azul" width="24" height="28" viewBox="0 0 30 25" fill="white"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M15.9998 13.3334C18.9454 13.3334 21.3332 10.9455 21.3332 8.00002C21.3332 5.0545 18.9454 2.66669 15.9998 2.66669C13.0543 2.66669 10.6665 5.0545 10.6665 8.00002C10.6665 10.9455 13.0543 13.3334 15.9998 13.3334ZM15.9998 10.6667C17.4726 10.6667 18.6665 9.47278 18.6665 8.00002C18.6665 6.52726 17.4726 5.33335 15.9998 5.33335C14.5271 5.33335 13.3332 6.52726 13.3332 8.00002C13.3332 9.47278 14.5271 10.6667 15.9998 10.6667Z" />
                    <path
                        d="M5.80042 20.5798C7.60684 17.9427 10.8276 16 16.0004 16C17.6354 16 19.0819 16.1931 20.3568 16.5477C21.0663 16.745 21.4815 17.4801 21.2842 18.1895C21.0868 18.899 20.3518 19.3141 19.6423 19.1168C18.6291 18.835 17.426 18.6667 16.0004 18.6667C11.5733 18.6667 9.23845 20.2795 8.00043 22.0869C7.00336 23.5424 6.63049 25.2527 6.60028 26.6667H18.6662C19.4026 26.6667 19.9996 27.2636 19.9996 28C19.9996 28.7364 19.4026 29.3334 18.6662 29.3334H5.33376C4.66132 29.3334 4.09412 28.8326 4.01072 28.1654C3.75911 26.1525 4.04942 23.136 5.80042 20.5798Z" />
                    <path
                        d="M25.3332 29.3334C24.5968 29.3334 23.9998 28.7364 23.9998 28V25.3334H21.3332C20.5968 25.3334 19.9998 24.7364 19.9998 24C19.9998 23.2636 20.5968 22.6667 21.3332 22.6667H23.9998V20C23.9998 19.2636 24.5968 18.6667 25.3332 18.6667C26.0695 18.6667 26.6665 19.2636 26.6665 20V22.6667H29.3332C30.0695 22.6667 30.6665 23.2636 30.6665 24C30.6665 24.7364 30.0695 25.3334 29.3332 25.3334H26.6665V28C26.6665 28.7364 26.0695 29.3334 25.3332 29.3334Z" />
                </svg>
                <a href="./cadastroFuncionario.html"></a>
            </li>

            <li onclick="trocarTela('cadastroMaquina')">
                <svg class="icons_azul" width="30" height="33" viewBox="0 0 42 32" fill="white"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M35.3333 29.3333C34.597 29.3333 34 28.7363 34 28V25.3333H31.3333C30.597 25.3333 30 24.7363 30 24C30 23.2636 30.597 22.6666 31.3333 22.6666H34V20C34 19.2636 34.597 18.6666 35.3333 18.6666C36.0697 18.6666 36.6667 19.2636 36.6667 20V22.6666H39.3333C40.0697 22.6666 40.6667 23.2636 40.6667 24C40.6667 24.7363 40.0697 25.3333 39.3333 25.3333H36.6667V28C36.6667 28.7363 36.0697 29.3333 35.3333 29.3333Z" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M2.88867 9.33329C2.88867 5.65139 5.87344 2.66663 9.55534 2.66663H22.8887C26.5706 2.66663 29.5553 5.65139 29.5553 9.33329V17.3333C29.5553 21.0152 26.5706 24 22.8887 24H9.55534C5.87344 24 2.88867 21.0152 2.88867 17.3333V9.33329ZM9.55534 5.33329C7.3462 5.33329 5.55534 7.12415 5.55534 9.33329V17.3333C5.55534 19.5424 7.3462 21.3333 9.55534 21.3333H22.8887C25.0978 21.3333 26.8887 19.5424 26.8887 17.3333V9.33329C26.8887 7.12415 25.0978 5.33329 22.8887 5.33329H9.55534ZM2.88867 28C2.88867 27.2636 3.48563 26.6666 4.22201 26.6666H28.222C28.9584 26.6666 29.5553 27.2636 29.5553 28C29.5553 28.7363 28.9584 29.3333 28.222 29.3333H4.22201C3.48563 29.3333 2.88867 28.7363 2.88867 28Z" />
                </svg>
                <a href="./cadastroMaquina.html"></a>
            </li>

            <li onclick="trocarTela('maquinaAlocada')">
                <svg class="icons_azul" width="25" height="25" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                    <path class="icons_azul" fill-rule="evenodd" clip-rule="evenodd"
                        d="M14.3933 4.5C8.92939 4.5 4.5 8.92939 4.5 14.3933C4.5 19.8572 8.92939 24.2866 14.3933 24.2866C17.1271 24.2866 19.5996 23.1798 21.3918 21.3861C23.1821 19.5944 24.2866 17.1243 24.2866 14.3933C24.2866 8.92939 19.8572 4.5 14.3933 4.5ZM1.5 14.3933C1.5 7.27253 7.27253 1.5 14.3933 1.5C21.5141 1.5 27.2866 7.27253 27.2866 14.3933C27.2866 17.4109 26.2485 20.1881 24.5122 22.3843L32.5672 30.4393C33.153 31.0251 33.153 31.9749 32.5672 32.5607C31.9814 33.1464 31.0316 33.1464 30.4459 32.5607L22.3916 24.5064C20.1943 26.2462 17.4143 27.2866 14.3933 27.2866C7.27253 27.2866 1.5 21.5141 1.5 14.3933Z"
                        fill="white" />
                </svg>

                <a href="./maquinaAlocada.html"></a>
            </li>
        </ul>

        <span id="logout" onclick="trocarTela('../index')">
            <svg class="icons_azul" width="24" height="30" viewBox="0 0 30 25" fill="white"
                xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M2.6665 5.33329C2.6665 3.86053 3.86041 2.66663 5.33317 2.66663H14.6665C16.1393 2.66663 17.3332 3.86053 17.3332 5.33329V7.99996C17.3332 8.73634 16.7362 9.33329 15.9998 9.33329C15.2635 9.33329 14.6665 8.73634 14.6665 7.99996V5.33329L5.33317 5.33329V26.6666H14.6665V24C14.6665 23.2636 15.2635 22.6666 15.9998 22.6666C16.7362 22.6666 17.3332 23.2636 17.3332 24V26.6666C17.3332 28.1394 16.1393 29.3333 14.6665 29.3333H5.33317C3.86041 29.3333 2.6665 28.1394 2.6665 26.6666V5.33329Z" />
                <path
                    d="M24.7809 17.3333L21.7237 20.3905C21.203 20.9112 21.203 21.7554 21.7237 22.2761C22.2444 22.7968 23.0886 22.7968 23.6093 22.2761L28.7541 17.1313C29.3789 16.5065 29.3789 15.4934 28.7541 14.8686L23.6093 9.72382C23.0886 9.20312 22.2444 9.20312 21.7237 9.72382C21.203 10.2445 21.203 11.0887 21.7237 11.6094L24.7809 14.6666L10.6665 14.6666V17.3333L24.7809 17.3333Z" />
            </svg>
            <a href="../index.html"></a>
        </span>
    </nav>

    <div class="container">
        <div class="containerComPadding">
            <header class="header">
                <div class="tituloDash">
                    <h1>Visão Geral</h1>
                </div>
            </header>

            <div class="containerKPIs">
                <div class="kpi">
                    <h5>Total de Notebooks</h5>
                    <h5 class="variavelKPINumber" id="qtdTotalNotebooks"></h5>
                </div>

                <div class="kpi">
                    <h5 style="color: rgb(0, 184, 0);">Paramêtro Normal</h5>
                    <p class="variavelKPI" id="parametroNormalCpu"></p>
                    <p class="variavelKPI" id="parametroNormalDisco"></p>
                    <p class="variavelKPI" id="parametroNormalMemoriaRam"></p>
                </div>

                <div class="kpi">
                    <h5 style="color: rgb(234, 255, 0);">Paramêtro Alarmante</h5>
                    <p class="variavelKPI" id="parametroAlarmanteCpu"></p>
                    <p class="variavelKPI" id="parametroAlarmanteDisco"></p>
                    <p class="variavelKPI" id="parametroAlarmanteMemoriaRam"></p>
                </div>

                <div class="kpi">
                    <h5 style="color: red;">Paramêtro Crítico</h5>
                    <p class="variavelKPI" id="parametroCriticoCpu"></p>
                    <p class="variavelKPI" id="parametroCriticoDisco"></p>
                    <p class="variavelKPI" id="parametroCriticoMemoriaRam"></p>
                </div>
            </div>

            <div class="containerMaquinas" id="containerMaquinas">
                <!-- Aqui vai aparecer as divzinhas com os notebooks que cadastrarmos-->
            </div>

        </div>
    </div>
</body>
<script>
    function trocarTela(tela) {
        window.location.href = `${tela}.html`;
    }

    window.onload = function () {
        listarNotebooks();
    };

    function listarNotebooks() {
        console.log("Estou no listar Notebooks!")
        const fkEmpresa = sessionStorage.getItem('ID_EMPRESA');

        fetch(`/notebook/listarNotebooks/${fkEmpresa}`, {
            method: "GET",
        }).then(function (resposta) {
            if (resposta.status == 200) {
                resposta.json().then(function (jsonNotebooks) {
                    console.log("O que ta vindo do BD: ", jsonNotebooks);
                    contarNotebooks(jsonNotebooks);
                    obterParametros();
                    listarAlocadas(jsonNotebooks);
                });
            } else {
                console.log("Deu ruim ao listar os Notes");
                resposta.text().then(function (texto) {
                    console.error("Erro: ", texto);
                });
            }
        }).catch(function (erro) {
            console.error("Erro na requisição da função do listar notebooks: ", erro);
        });
    }

    function contarNotebooks(jsonNotebooks) { //Usei para a kpi do total de notebook 
        console.log("Estou no contar Notebooks!");
        console.log(jsonNotebooks.length);
        var totalNotebooks = jsonNotebooks.length;
        qtdTotalNotebooks.innerHTML = totalNotebooks;
    }

    function obterParametros() { // Pega do banco, os parâmetros conforme a fkempresa
        const fkEmpresa = sessionStorage.getItem('ID_EMPRESA');
        console.log("fkEmpresa do sessionStorage: " + fkEmpresa);

        fetch(`/empresas/obterParametros/${fkEmpresa}`, {
            method: "GET",
        }).then(function (resposta) {
            if (resposta.status === 200) {
                resposta.json().then(function (jsonParametros) {
                    console.log("Parâmetros que estão vindo: ", jsonParametros);
                    preencherParametros(jsonParametros);
                });
            } else {
                console.log("Erro ao tentar trazer os Parâmetros: ", resposta.statusText);
            }
        }).catch(function (erro) {
            console.error("Erro na requisição dos Parâmetros: ", erro);
        });
    }

    function preencherParametros(jsonParametros) { // Popula as kpis dos parâmetros
        if (Array.isArray(jsonParametros)) {
            jsonParametros = jsonParametros[0];
        }

        var parametroNormalCpu = document.getElementById("parametroNormalCpu");
        var parametroNormalDisco = document.getElementById("parametroNormalDisco");
        var parametroNormalMemoriaRam = document.getElementById("parametroNormalMemoriaRam");
        var parametroAlarmanteCpu = document.getElementById("parametroAlarmanteCpu");
        var parametroAlarmanteDisco = document.getElementById("parametroAlarmanteDisco");
        var parametroAlarmanteMemoriaRam = document.getElementById("parametroAlarmanteMemoriaRam");
        var parametroCriticoCpu = document.getElementById("parametroCriticoCpu");
        var parametroCriticoDisco = document.getElementById("parametroCriticoDisco");
        var parametroCriticoMemoriaRam = document.getElementById("parametroCriticoMemoriaRam");

        parametroNormalCpu.innerHTML = `Uso da CPU até: ${jsonParametros.UsoNormalCpu}%`;
        parametroNormalDisco.innerHTML = `Uso do Disco até: ${jsonParametros.UsoNormalDisco}%`;
        parametroNormalMemoriaRam.innerHTML = `Uso da Memória até: ${jsonParametros.UsoNormalMemoriaRam}%`;

        parametroAlarmanteCpu.innerHTML = `Uso da CPU: +${jsonParametros.UsoAlarmanteCpu}%`;
        parametroAlarmanteDisco.innerHTML = `Uso do Disco: +${jsonParametros.UsoAlarmanteDisco}%`;
        parametroAlarmanteMemoriaRam.innerHTML = `Uso da Memória: +${jsonParametros.UsoAlarmanteMemoriaRam}%`;

        parametroCriticoCpu.innerHTML = `Uso da CPU: +${jsonParametros.UsoCriticoCpu}%`;
        parametroCriticoDisco.innerHTML = `Uso do Disco: +${jsonParametros.UsoCriticoDisco}%`;
        parametroCriticoMemoriaRam.innerHTML = `Uso da Memória: +${jsonParametros.UsoCriticoMemoriaRam}%`;
    }

    function listarAlocadas(jsonNotebooks) {
        const idEmpresa = sessionStorage.getItem('ID_EMPRESA');

        fetch(`/empresas/listarAlocadas/${idEmpresa}`, {
            method: "GET"
        }).then(function (resposta) {
            if (resposta.status == 200) {
                resposta.json().then(function (alocadas) {
                    console.log("Alocações existentes: ", alocadas);
                    obterNumeroESerieEmail(jsonNotebooks, alocadas);
                });
            } else {
                console.log("Não deu para listar as alocações");
                resposta.text().then(function (texto) {
                    console.error("Erro: ", texto);
                });
            }
        }).catch(function (erro) {
            console.error("Erro na requisição: ", erro);
        });
    }

    function obterNumeroESerieEmail(jsonNotebooks, alocadas) { // Pega o numero do email do usuario que ta utilizando a maquina de acordo com o numero de serie do notebook
        const resultados = [];

        jsonNotebooks.forEach(notebook => {
            const { numeroSerie } = notebook;

            const alocacao = alocadas.find(aloc => aloc.numeroSerie === numeroSerie);

            if (alocacao) {
                fetch(`/notebook/obterUsuarioNotebook/${numeroSerie}`, {
                    cache: 'no-store'
                }).then(resposta => {
                    if (resposta.status == 200) {
                        return resposta.json();
                    } else {
                        console.log(`Erro no OBTER NUMERO E SERIE E EMAIL ${numeroSerie}`);
                        return { emailUsuario: 'Email não encontrado' };
                    }
                }).then(jsonUsuario => {
                    const emailUsuario = jsonUsuario[0] ? jsonUsuario[0].emailUsuario : 'email não encontrado';
                    resultados.push({ numeroSerie, emailUsuario });
                    if (resultados.length === jsonNotebooks.length) {
                        renderizarNotebooks(resultados);
                    }
                }).catch(erro => {
                    console.error(`Erro na requisição de trazer o user do note ${numeroSerie}: ${erro}`);
                    resultados.push({ numeroSerie, emailUsuario: 'Erro ao trazer o email' });
                    if (resultados.length === jsonNotebooks.length) {
                        renderizarNotebooks(resultados);
                    }
                });
            } else {
                resultados.push({ numeroSerie, emailUsuario: 'Máquina não alocada!' });
                if (resultados.length === jsonNotebooks.length) {
                    renderizarNotebooks(resultados);
                }
            }
        });
    }

    function obterDados(numeroSerie) { //puxa os dados igual no dashespecifico mas aqui so usamos o primeiro valor que é o do uso da cpu
    return fetch(`/notebook/obterDadosGraficos/${numeroSerie}`, { cache: 'no-store' })
        .then(function (response) {
            if (response.ok) {
                return response.json().then(function (resposta) {
                    console.log("Dados gráficos: ", resposta);
                    return resposta[0].usoCPU; // Certifique-se de que 'usoCPU' é a chave correta
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API ' + response);
                return null;
            }
        })
        .catch(function (error) {
            console.error('Erro ao buscar dados do gráfico:', error);
            return null;
        });
}

function validarUsoCPU(numeroSerie, usoCPU) { // pegamos o valor do uso da cpu e faz uma validacao para geraruma sinalizaçao de acordo com o parametro
    const condicaoNotebook = document.getElementById(`condicaoNotebook_${numeroSerie}`);
    if (!condicaoNotebook) {
        console.error(`Elemento condicaoNotebook_${numeroSerie} não encontrado.`);
        return;
    }

    let textoCondicao = '';
    let corCondicao = '';

    if (usoCPU === null) {
        textoCondicao = 'Sem Dados';
        corCondicao = '#8979ab';
    } else if (usoCPU >= 85) {
        textoCondicao = 'Crítico';
        corCondicao = 'red';
    } else if (usoCPU >= 50) {
        textoCondicao = 'Alarmante';
        corCondicao = 'yellow';
    } else {
        textoCondicao = 'Normal';
        corCondicao = 'green';
    }

    // Atualizar o conteúdo e o estilo do elemento condicaoNotebook
    condicaoNotebook.textContent = textoCondicao;
    condicaoNotebook.style.color = corCondicao;
}

function renderizarNotebooks(resultados) { //renderiza os notebooks igual antes mas aqui ele chama a funcao obter dados e de validar o uso da cpu, fica maisi dinamico
    const containerMaquinas = document.getElementById("containerMaquinas");
    containerMaquinas.innerHTML = "";
    resultados.forEach(({ numeroSerie, emailUsuario }) => {
        const notebookDiv = document.createElement("div");
        notebookDiv.classList.add("maquina");

        notebookDiv.innerHTML = `
            <p id="condicaoNotebook_${numeroSerie}" class="condicaoPadraoNotebook"></p>
            <img class="imgMaquina" src="../assets/imagens/Laptop2.png" alt=""/>
            <p class="txtMaquinas">Número de Série: <span class="txtMaquinas2">${numeroSerie}</span></p>
            <p class="txtMaquinas" style="color: #59d9bb;">Usuário: <span class="txtMaquinas2">${emailUsuario}</span></p>
            <button class="botaoDetalhes" onclick="verDetalhes('${numeroSerie}', '${emailUsuario}')">Ver detalhes</button>
        `;

        containerMaquinas.appendChild(notebookDiv);

        obterDados(numeroSerie).then(usoCPU => {
            validarUsoCPU(numeroSerie, usoCPU);
        });
    });
}

function verDetalhes(numeroSerie, emailUsuario) {
    window.location.href = `dashEspecifico.html?serie=${numeroSerie}&email=${encodeURIComponent(emailUsuario)}`;
}
</script>