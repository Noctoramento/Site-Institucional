<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Noctoramento | Alocação máquina</title>
  <link rel="stylesheet" href="../css/maquinaAlocada.css">
  <link rel="icon" href="../assets/Imagens/Logo Verde água neon.png">
  <link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css'
    type='text/css'>

</head>

<body onload="listarAlocadas()">
  <header>
    <div id="tituloDash" style="display: none; ">
      <h1 style="font-weight: 700;">Cadastrar funcionario</h1>
    </div>

    <div id="div_User" class="User" style="font-size: 13px;">
      <svg width="32" height="32" viewBox="0 0 38 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M26.6663 24.6667C26.6663 27.244 21.8907 28 15.9997 28C10.1086 28 5.33301 27.244 5.33301 24.6667C5.33301 22.0893 10.1086 18.6667 15.9997 18.6667C21.8907 18.6667 26.6663 22.0893 26.6663 24.6667Z"
          stroke="#F7F9FC" stroke-width="3" />
        <path
          d="M21.333 9.33333C21.333 12.2789 18.9452 14.6667 15.9997 14.6667C13.0542 14.6667 10.6663 12.2789 10.6663 9.33333C10.6663 6.38781 13.0542 4 15.9997 4C18.9452 4 21.333 6.38781 21.333 9.33333Z"
          stroke="#F7F9FC" stroke-width="3" />
      </svg>

      <p>
        Fernanda Caramico<br />
        <span style="color: rgb(18, 201, 18)">Administrador</span>
      </p>
    </div>
  </header>
  <nav class="navbar">
    <img class="img_navbar" src="../assets/icons_img/Logo Verde água escuro.png" alt="" />

    <ul class="icons_navbar">
      <li onclick="trocarTela('DashboardGeral')">
        <svg class="icons_azul" width="24" height="24" viewBox="0 0 30 25" fill="white"
          xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M3.4737 0.0560913C1.7378 0.0560913 0.330566 1.46993 0.330566 3.21399V20.8982C0.330566 22.6423 1.63302 24.0561 3.36893 24.0561H26.5233C28.2592 24.0561 29.6665 22.6423 29.6665 20.8982V3.21399C29.6665 1.46993 28.2592 0.0560913 26.5233 0.0560913H3.4737ZM3.26416 3.21399C3.26416 3.09772 3.35797 3.00346 3.4737 3.00346H9.13134V21.1087H3.4737C3.35797 21.1087 3.26416 21.0145 3.26416 20.8982V3.21399ZM12.0649 21.1087H17.9321V13.5298H12.0649V21.1087ZM12.0649 10.5824V3.00346H26.5233C26.6391 3.00346 26.7329 3.09772 26.7329 3.21399V10.5824L12.0649 10.5824ZM26.7329 13.5298H20.8657V21.1087H26.5233C26.6391 21.1087 26.7329 21.0145 26.7329 20.8982V13.5298Z" />
        </svg>
        <a href="./DashboardGeral.html"></a>
      </li>

      <li>
        <svg width="24" height="26" viewBox="0 0 30 25" fill="aqua" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M10.6665 5.33335C10.6665 3.8606 11.8604 2.66669 13.3332 2.66669H18.6665C20.1393 2.66669 21.3332 3.86059 21.3332 5.33335V10.6667H26.6665C28.1393 10.6667 27.3332 11.8606 29.3332 13.3334V26.6667C29.3332 28.1394 28.1393 29.3334 26.6665 29.3334H5.33317C3.86041 29.3334 2.6665 28.1394 2.6665 26.6667V18.6667C2.6665 17.1939 3.86041 16 5.33317 16H10.6665V5.33335ZM18.6665 26.6667V5.33335L13.3332 5.33335V26.6667H18.6665ZM21.3332 13.3334V26.6667H26.6665V13.3334H21.3332ZM5.33317 18.6667H10.6665V26.6667H5.33317V18.6667Z" />
        </svg>
      </li>

      <li onclick="trocarTela('cadastroFuncionario')">
        <svg class="icons_azul" width="24" height="28" viewBox="0 0 30 25" fill="white"
          xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M15.9998 13.3334C18.9454 13.3334 21.3332 10.9455 21.3332 8.00002C21.3332 5.0545 18.9454 2.66669 15.9998 2.66669C13.0543 2.66669 10.6665 5.0545 10.6665 8.00002C10.6665 10.9455 13.0543 13.3334 15.9998 13.3334ZM15.9998 10.6667C17.4726 10.6667 18.6665 9.47278 18.6665 8.00002C18.6665 6.52726 17.4726 5.33335 15.9998 5.33335C14.5271 5.33335 13.3332 6.52726 13.3332 8.00002C13.3332 9.47278 14.5271 10.6667 15.9998 10.6667Z" />
          <path
            d="M5.80042 20.5798C7.60684 17.9427 10.8276 16 16.0004 16C17.6354 16 19.0819 16.1931 20.3568 16.5477C21.0663 16.745 21.4815 17.4801 21.2842 18.1895C21.0868 18.899 20.3518 19.3141 19.6423 19.1168C18.6291 18.835 17.426 18.6667 16.0004 18.6667C11.5733 18.6667 9.23845 20.2795 8.00043 22.0869C7.00336 23.5424 6.63049 25.2527 6.60028 26.6667H18.6662C19.4026 26.6667 19.9996 27.2636 19.9996 28C19.9996 28.7364 19.4026 29.3334 18.6662 29.3334H5.33376C4.66132 29.3334 4.09412 28.8326 4.01072 28.1654C3.75911 26.1525 4.04942 23.136 5.80042 20.5798Z" />
          <path
            d="M25.3332 29.3334C24.5968 29.3334 23.9998 28.7364 23.9998 28V25.3334H21.3332C20.5968 25.3334 19.9998 24.7364 19.9998 24C19.9998 23.2636 20.5968 22.6667 21.3332 22.6667H23.9998V20C23.9998 19.2636 24.5968 18.6667 25.3332 18.6667C26.0695 18.6667 26.6665 19.2636 26.6665 20V22.6667H29.3332C30.0695 22.6667 30.6665 23.2636 30.6665 24C30.6665 24.7364 30.0695 25.3334 29.3332 25.3334H26.6665V28C26.6665 28.7364 26.0695 29.3334 25.3332 29.3334Z" />
        </svg>
        <a href="./cadastroFuncionario.html"></a>
      </li>

      <li onclick="trocarTela('cadastroMaquina')">
        <svg class="icons_azul" width="30" height="33" viewBox="0 0 42 32" fill="white"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M35.3333 29.3333C34.597 29.3333 34 28.7363 34 28V25.3333H31.3333C30.597 25.3333 30 24.7363 30 24C30 23.2636 30.597 22.6666 31.3333 22.6666H34V20C34 19.2636 34.597 18.6666 35.3333 18.6666C36.0697 18.6666 36.6667 19.2636 36.6667 20V22.6666H39.3333C40.0697 22.6666 40.6667 23.2636 40.6667 24C40.6667 24.7363 40.0697 25.3333 39.3333 25.3333H36.6667V28C36.6667 28.7363 36.0697 29.3333 35.3333 29.3333Z" />
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M2.88867 9.33329C2.88867 5.65139 5.87344 2.66663 9.55534 2.66663H22.8887C26.5706 2.66663 29.5553 5.65139 29.5553 9.33329V17.3333C29.5553 21.0152 26.5706 24 22.8887 24H9.55534C5.87344 24 2.88867 21.0152 2.88867 17.3333V9.33329ZM9.55534 5.33329C7.3462 5.33329 5.55534 7.12415 5.55534 9.33329V17.3333C5.55534 19.5424 7.3462 21.3333 9.55534 21.3333H22.8887C25.0978 21.3333 26.8887 19.5424 26.8887 17.3333V9.33329C26.8887 7.12415 25.0978 5.33329 22.8887 5.33329H9.55534ZM2.88867 28C2.88867 27.2636 3.48563 26.6666 4.22201 26.6666H28.222C28.9584 26.6666 29.5553 27.2636 29.5553 28C29.5553 28.7363 28.9584 29.3333 28.222 29.3333H4.22201C3.48563 29.3333 2.88867 28.7363 2.88867 28Z" />
        </svg>
        <a href="./cadastroMaquina.html"></a>
      </li>

      <li onclick="trocarTela('maquinaAlocada')">
        <svg class="icons_azul" width="25" height="25" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
          <path class="icons_azul" fill-rule="evenodd" clip-rule="evenodd"
            d="M14.3933 4.5C8.92939 4.5 4.5 8.92939 4.5 14.3933C4.5 19.8572 8.92939 24.2866 14.3933 24.2866C17.1271 24.2866 19.5996 23.1798 21.3918 21.3861C23.1821 19.5944 24.2866 17.1243 24.2866 14.3933C24.2866 8.92939 19.8572 4.5 14.3933 4.5ZM1.5 14.3933C1.5 7.27253 7.27253 1.5 14.3933 1.5C21.5141 1.5 27.2866 7.27253 27.2866 14.3933C27.2866 17.4109 26.2485 20.1881 24.5122 22.3843L32.5672 30.4393C33.153 31.0251 33.153 31.9749 32.5672 32.5607C31.9814 33.1464 31.0316 33.1464 30.4459 32.5607L22.3916 24.5064C20.1943 26.2462 17.4143 27.2866 14.3933 27.2866C7.27253 27.2866 1.5 21.5141 1.5 14.3933Z"
            fill="white" />
        </svg>

        <a href="./maquinaAlocada.html"></a>
      </li>

      <li id="logout" onclick="trocarTela('../index')">
        <svg class="icons_azul" width="24" height="30" viewBox="0 0 30 25" fill="white"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M2.6665 5.33329C2.6665 3.86053 3.86041 2.66663 5.33317 2.66663H14.6665C16.1393 2.66663 17.3332 3.86053 17.3332 5.33329V7.99996C17.3332 8.73634 16.7362 9.33329 15.9998 9.33329C15.2635 9.33329 14.6665 8.73634 14.6665 7.99996V5.33329L5.33317 5.33329V26.6666H14.6665V24C14.6665 23.2636 15.2635 22.6666 15.9998 22.6666C16.7362 22.6666 17.3332 23.2636 17.3332 24V26.6666C17.3332 28.1394 16.1393 29.3333 14.6665 29.3333H5.33317C3.86041 29.3333 2.6665 28.1394 2.6665 26.6666V5.33329Z" />
          <path
            d="M24.7809 17.3333L21.7237 20.3905C21.203 20.9112 21.203 21.7554 21.7237 22.2761C22.2444 22.7968 23.0886 22.7968 23.6093 22.2761L28.7541 17.1313C29.3789 16.5065 29.3789 15.4934 28.7541 14.8686L23.6093 9.72382C23.0886 9.20312 22.2444 9.20312 21.7237 9.72382C21.203 10.2445 21.203 11.0887 21.7237 11.6094L24.7809 14.6666L10.6665 14.6666V17.3333L24.7809 17.3333Z" />
        </svg>
        <a href="../index.html"></a>
      </li>
    </ul>
  </nav>
  <main>
    <section class="tamanho-padrao">
      <h2>ALOCAÇÃO</h2>
      <div class="container">
        <div class="btn-inp">
          <button id="alocarMaquina" onclick="cadastrar()">Alocar máquina</button>
          <div class="pesquisar">
            <input class="pesquisar-btn" type="text" placeholder="Pesquisar..." id="pesquisar" onkeyup="pesquisar()">
            <div id="lupa"></div>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="tabela" id="tabelaAlocada">
            <thead>
              <tr>
                <th>#</th>
                <th>Nome</th>
                <th>Cargo</th>
                <th>NumeroSerie</th>
                <th>Modelo</th>
                <th>Data de ínicio</th>
                <th>Remover</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <div id="form-alocada">
        <div class="cadastro-funcionario">
          <h2>Alocar máquina</h2>
          <div class="container-tabela">
            <div class="table-pop">
              <table class="tabelaMaquina" id="tabelaMaquinas">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>NumeroSérie</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
          <div class="cadastro-btn">
            <button class="cancelar-btn" onclick="cancelar()">Cancelar</button>
          </div>
        </div>
    </section>
    <div id="form-editar">
      <div class="editar-funcionario">
        <h2>Deseja adicionar um responsável? </h2>
        <div class="cadastro-input">
          <select name="funcionarios" id="select_funcionarios" selected></select>
        </div>
        <div class="cadastro-btn">
          <button class="funcionario-btn" onclick="salvar()">Alocar</button>
          <button class="cancelar-btn" onclick="fechar()">Cancelar</button>
        </div>
      </div>
  </main>

</body>

</html>

<script>

  function pesquisar() {

    var input, filter, table, tr, td, i, j, txtValue;
    input = document.getElementById("pesquisar");
    filter = input.value.toUpperCase();
    table = document.getElementById("tabelaAlocada");
    tr = table.getElementsByTagName("tr");


    for (i = 1; i < tr.length; i++) {
      tr[i].style.display = "none";
      td = tr[i].getElementsByTagName("td");
      for (j = 0; j < td.length; j++) {
        if (td[j]) {
          txtValue = td[j].textContent || td[j].innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
            break;
          }
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', (event) => {
    listarMaquinasNaoAlocadas();
    listarAlocadas();
  });


  function cadastrar() {
    document.getElementById("form-alocada").style.display = "block";
  }

  function cancelar() {
    document.getElementById("form-alocada").style.display = "none";
  }

  function trocarTela(tela) {
    window.location.href = `${tela}.html`;
  }


  function listarMaquinasNaoAlocadas() {
    const idEmpresa = sessionStorage.getItem('ID_EMPRESA');

    if (!idEmpresa) {
      console.log('ID da empresa não encontrado no sessionStorage');
      return;
    }

    fetch(`/empresas/listarMaquinasNaoAlocadas/${idEmpresa}`, {
      method: "GET"
    })
      .then(function (resposta) {
        if (!resposta.ok) {
          throw new Error('Erro na resposta da API');
        }
        return resposta.json();
      })
      .then(function (maquinas) {
        if (!Array.isArray(maquinas)) {
          throw new Error('Resposta da API não é um array');
        }

        const tabelaMaquinas = document.getElementById('tabelaMaquinas').getElementsByTagName('tbody')[0];
        tabelaMaquinas.innerHTML = '';
        maquinas.forEach((maquina, index) => {
          tabelaMaquinas.innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${maquina.numeroSerie}</td>
                    <td>${maquina.fabricante}</td>
                    <td>${maquina.modelo}</td>
                    <td><button onclick="alocar(${maquina.idNotebook})" ><img  class="img-btn" src="../assets/icons_img/botao-editar.png" alt=""></button></td>
                </tr>`;
        });
      })
      .catch(function (erro) {
        console.log(`ERRO: ${erro}`);
      });
  }

  function listarFuncionariosNaoAlocados() {
    
    const idEmpresa = parseInt(sessionStorage.getItem('ID_EMPRESA'));

    if (!idEmpresa) {
      console.log('ID da empresa não encontrado no sessionStorage');
      return;
    }

    let cargosArmazenados;
    listarCargos().then((cargos) => {
      cargosArmazenados = cargos;
      fetch(`/empresas/listarFuncionariosNaoAlocados/${idEmpresa}`, {
        method: "GET"
      })
        .then(function (resposta) {
          if (!resposta.ok) {
            throw new Error('Erro na resposta da API');
          }
          return resposta.json();
        })
        .then(function (funcionarios) {
          if (!Array.isArray(funcionarios)) {
            throw new Error('Resposta da API não é um array');
          }

          const selectFun = document.getElementById('select_funcionarios');
          funcionarios.forEach(funcionario => {
            if (parseInt(funcionario.fkEmpresa) === idEmpresa) {
              const cargo = cargosArmazenados[funcionario.fkCargo] || 'Cargo desconhecido';
              selectFun.innerHTML += `<option value='${funcionario.idUsuario}'>${funcionario.nomeUsuario} - ${cargo}</option>`;
            }
          });
        })
        .catch(function (erro) {
          console.log(`ERRO: ${erro}`);
        });
    });
  }


  function listarCargos() {
    return fetch("/empresas/listarCargos", {
      method: "GET"
    })
      .then(function (resposta) {
        if (!resposta.ok) {
          throw new Error('Erro na resposta da API');
        }
        return resposta.json();
      })
      .then(function (cargos) {
        const cargosArmazenados = {};
        cargos.forEach((cargo) => {
          cargosArmazenados[cargo.idCargo] = cargo.nomeCargo;
        });
        return cargosArmazenados;
      })
      .catch(function (erro) {
        console.log(`ERRO: ${erro}`);
      });
  }

  let idMaquinaSelecionada;
  let cargosArmazenados = {};

  function init() {
    listarCargos().then(() => {
      listarFuncionariosNaoAlocados();
    });
  }

  window.onload = init;

  function salvar() {
    var id = idMaquinaSelecionada;
    var funcionario = document.getElementById('select_funcionarios').value;

    if (funcionario !== "") {
      fetch("/usuarios/alocarFuncionario", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          idServer: id,
          funcionarioServer: funcionario,
          empresaServer: sessionStorage.ID_EMPRESA
        }),
      })
        .then(response => response.json())
        .then(data => {
          alert("Funcionário alocado com sucesso");
          console.log('Success:', data);
        })
        .catch((error) => {
          alert("Erro ao alocar o funcionário");
          console.error('Error:', error);
        });
    } else {
      alert("Insira todos os campos");
    }
    fechar();
  }

  function listarAlocadas() {
    const idEmpresa = sessionStorage.getItem('ID_EMPRESA');

    if (!idEmpresa) {
      console.log('ID da empresa não encontrado no sessionStorage');
      return;
    }

    fetch(`/empresas/listarAlocadas/${idEmpresa}`, {
      method: "GET"
    })
      .then(function (resposta) {
        if (!resposta.ok) {
          throw new Error('Erro na resposta da API');
        }
        return resposta.json();
      })
      .then(function (alocada) {
        const tabelaAlocada = document.getElementById('tabelaAlocada').getElementsByTagName('tbody')[0];
        tabelaAlocada.innerHTML = '';
        alocada.forEach((alocacao, index) => {
          const dataFormatada = formatarData(alocacao.dataUsoInicio);
          tabelaAlocada.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${alocacao.nomeUsuario}</td>
            <td>${alocacao.nomeCargo}</td>
            <td>${alocacao.numeroSerie}</td>
            <td>${alocacao.modelo}</td>
            <td>${dataFormatada}</td>
            <td><button onclick="excluir(${alocacao.fkNotebook}, ${alocacao.fkEmpresaNotebook}, ${alocacao.fkUsuario}, ${alocacao.fkEmpresaUsuario})"><img class="img-btn" src="../assets/icons_img/delete.png" alt=""></button></td>
          </tr>`;
        });
      })
      .catch(function (erro) {
        console.log(`ERRO: ${erro}`);
      });
  }

  function formatarData(data) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(data).toLocaleDateString('pt-BR', options);
  }

  function alocar(idNotebook) {
    document.getElementById("form-editar").style.display = "flex";
    idMaquinaSelecionada = idNotebook;
    console.log(idMaquinaSelecionada);
  }

  function fechar() {
    document.getElementById("form-editar").style.display = "none";
  }

  function excluir(fkNotebook, fkEmpresaNotebook, fkUsuario, fkEmpresaUsuario) {
    console.log(fkNotebook);

    fetch("/usuarios/apagarAlocacao", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        fkNotebook: fkNotebook,
        fkEmpresaNotebook: fkEmpresaNotebook,
        fkUsuario: fkUsuario,
        fkEmpresaUsuario: fkEmpresaUsuario
      }),
    })
      .then(response => response.json())
      .then(data => {
        alert("Alocação excluída com sucesso");
        console.log('Success:', data);
      })
      .catch((error) => {
        alert("Erro ao excluir a alocação");
        console.error('Error:', error);
      });
    fechar();
  }


</script>